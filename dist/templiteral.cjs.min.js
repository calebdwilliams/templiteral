"use strict";Object.defineProperty(exports,"__esModule",{value:true});const valuePattern=/---!{.*?(}!---)/gi;const eventPattern=/^\(.*\)$/gi;const propPattern=/^\[.*\]$/;const sanitizePattern=/^this\./;const startSeparator=/---!\{/gi;const endSeparator=/\}!---/gi;const modelPattern=/t-model/gi;const modelSymbol=Symbol("t-model");class ContentNode{constructor(e,t){this.node=e;this.compiler=t;this.base=e.nodeValue||"";this.indicies=this.base.match(valuePattern).map(e=>+e.replace(startSeparator,"").replace(endSeparator,""));this.indicies.forEach(e=>this.compiler.partIndicies.set(e,this))}set value(e){const t=this.base.replace(valuePattern,e);this.value!==t?this.node.nodeValue=t:null}get value(){return this.node.nodeValue}setValue(e=[]){this.node.nodeValue=this.base.replace(/---!{*.}!---/g,t=>e[+t.replace(startSeparator,"").replace(endSeparator,"")])}update(e){this.node.nodeValue=this.base.replace(/---!{*.}!---/g,t=>{const s=e[+t.replace(startSeparator,"").replace(endSeparator,"")];return s===null?"":s})}}class AttributeNode{constructor(e,t,s,n,a){this.node=e;this.boundAttrs=t;this.boundEvents=s;this.context=n;this.compiler=a;this.boundAttrs.forEach(e=>{e.base=e.value;const t=e.base.match(valuePattern)||[];this.indicies=t.map(e=>+e.replace(startSeparator,"").replace(endSeparator,""));this.indicies.forEach(e=>this.compiler.partIndicies.set(e,this))});this.addListeners()}addListeners(){this.boundEvents.forEach((e,t)=>{if(t===modelSymbol){this.context[e]=this.context[e]?this.context[e]:undefined;this.node.value=this.context[e];this.node.addEventListener("input",this._modelFunction(e));this.node.addEventListener("change",this._modelFunction(e))}else{const s=e.split(/;/);const n=s.filter(e=>e.match(sanitizePattern));const a=n.join("; ");if(e.match(sanitizePattern)){const e=Reflect.construct(Function,["event",a]).bind(this.context);this.node.addEventListener(t,e);this.node._boundEvents=e}if(n.length<s.length){console.warn("Inline functions not allowed inside of event bindings. Unsafe functions have been removed from node",this.node)}}})}updateProperty(e,t){const s=e.name.replace(/\[|\]/g,"");this.node[s]=t;if(t&&(t!=="false"&&t!=="undefined")){this.node.setAttribute(s,t)}else{this.node[s]=false;this.node.removeAttribute(s)}}update(e){this.boundAttrs.forEach(t=>{const s=t.base.match(/---!{*.}!---/g)||[];const n=s.map(e=>+e.replace("---!{","").replace("}!---",""));let a=t.base;if(n.length===1){a=a.replace(`---!{${n[0]}}!---`,e[n[0]])}else if(n.length>1){for(let t=0;t<n.length;t+=1){const s=e[n[t]]||"";a=a.replace(`---!{${n[t]}}!---`,s)}}t.value=a;if(t.name.match(propPattern)){if(n.length===1){a=e[n[0]]}this.updateProperty(t,a)}})}_modelFunction(e){const{context:t}=this;return function(){t[e]=this.value}}}class Template{constructor(e,t,s,n){this.strings=e;this.values=t;this.oldValues=t.map((e,t)=>`---!{${t}}!---`);this.location=s;this.context=n;this.parts=[];this.partIndicies=new Map;this.eventHandlers=[];this._init()}_append(e){for(let e=0;e<this.parts.length;e+=1){const t=this.parts[e];if(t instanceof ContentNode){t.setValue(this.values,this.oldValues[e])}else if(t instanceof AttributeNode){t.update(this.values,this.oldValues)}}this.location.appendChild(e)}_init(){const e=this.strings.map((e,t)=>`${e?e:""}${this.values[t]!==undefined?"---!{"+t+"}!---":""}`).join("");const t=document.createElement("template");t.innerHTML=e;const s=document.importNode(t.content,true);const n=document.createTreeWalker(s,133,null,false);this._walk(n,this.parts,true);this._append(s)}_walk(e,t){while(e.nextNode()){const{currentNode:s}=e;if(!s.__templiteralCompiler){switch(s.nodeType){case 1:{const{attributes:e}=s;if(e.length){const n=new Map;const a=new Map;for(let t=0;t<e.length;t+=1){const i=e[t];if(i.value.match(valuePattern)||i.name.match(propPattern)){n.set(i.name,i)}if(i.name.match(eventPattern)){const e=i.name.substring(1,i.name.length-1);a.set(e,i.value);this.eventHandlers.push({eventName:e,currentNode:s})}if(i.name.match(modelPattern)){a.set(modelSymbol,i.value)}}if(n.size>=1||a.size>=1){const e=new AttributeNode(s,n,a,this.context,this);t.push(e)}}break}case 3:{if(s.textContent&&s.textContent.match(valuePattern)){const e=new ContentNode(s,this);t.push(e)}break}}}else{this.templiteralParts.add(s)}}}update(e){this.oldValues=this.values;this.values=e;for(let t=0;t<e.length;t+=1){if(e[t]!==this.oldValues[t]){this.partIndicies.get(t).update(e)}}}}class TRepeat extends HTMLElement{constructor(){super();this.templiteral=templiteral}connectedCallback(){this._render()}_render(){this.templiteral()(this.items.map(this.templatecallback()))}}if(!customElements.get("t-repeat")){customElements.define("t-repeat",TRepeat)}class TIf extends HTMLElement{constructor(){super();this.cached=[]}connectedCallback(){this.style.display="contents"}set condition(e){if(e===false){Array.from(this.children).map(e=>{this.cached.push(e);this.removeChild(e)});this.innerHTML=""}else if(e===true){this.cached.forEach(e=>this.appendChild(e));this.cached=[]}}}if(!customElements.get("t-if")){customElements.define("t-if",TIf)}const templateCache=new WeakMap;function templiteral(e=this,t=this){e.shadowRoot?e=e.shadowRoot:null;return(s,...n)=>{let a=templateCache.get(e);if(a){a.update(n)}else{a=new Template(s,n,e,t);templateCache.set(e,a)}return a}}exports.templiteral=templiteral;