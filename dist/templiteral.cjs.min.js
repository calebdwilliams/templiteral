"use strict";Object.defineProperty(exports,"__esModule",{value:true});const valuePattern=/---!{.*?(}!---)/gi;const propPattern=/^\[.*\]$/;const matchPattern=/---!{\d+}!---/gi;const deepEqual=(e,t)=>{if(e===t)return true;if(e&&t&&typeof e=="object"&&typeof t=="object"){const s=Array.isArray(e);const n=Array.isArray(t);let o;let i;let r;if(s&&n){i=e.length;if(i!=t.length)return false;for(o=i;o--!==0;)if(!deepEqual(e[o],t[o]))return false;return true}if(s!=n)return false;const a=e instanceof Date;const c=t instanceof Date;if(a!=c)return false;if(a&&c)return e.getTime()==t.getTime();const l=e instanceof RegExp;const h=t instanceof RegExp;if(l!=h)return false;if(l&&h)return e.toString()==t.toString();const d=Object.keys(e);i=d.length;if(i!==Object.keys(t).length)return false;for(o=i;o--!==0;)if(!Object.hasOwnProperty.call(t,d[o]))return false;for(o=i;o--!==0;){r=d[o];if(!deepEqual(e[r],t[r]))return false}return true}else if(e&&t&&typeof e=="function"&&typeof t=="function"){return true}return e!==e&&t!==t};const protectProperty=(e,t,s)=>Object.defineProperty(e,t,{value:s,enumerable:false,configurable:false,writable:false});const protectGet=(e,t,s)=>Object.defineProperty(e,t,{get:s,configurable:false,enumerable:false});const rendererSymbol=Symbol("Renderer");const repeaterSymbol=Symbol("Repeater");const removeSymbol=Symbol("RemoveTemplate");const templateSymbol=Symbol();const valueToInt=e=>+e.replace(/(---!{)|(}!---)/gi,"");const toEventName=e=>e.replace(/(\()|(\))/gi,"");const nullProps=(e,t)=>t.forEach(t=>e[t]=null);class ContentNode{constructor(e,t){this.node=e;this.compiler=t;this.base=e.nodeValue||"";this.indicies=this.base.match(valuePattern).map(valueToInt);this.indicies.forEach(e=>this.compiler.partIndicies.set(e,this))}update(e){this.node.nodeValue=this.base.replace(matchPattern,t=>{const s=e[valueToInt(t)];return s===null?"":e[valueToInt(t)]})}}class AttributeNode{constructor(e,t,s,n,o){this.node=e;this.boundAttrs=t;this.boundEvents=s;this.context=n;this.compiler=o;this.boundAttrs.forEach(e=>{e.base=e.value;e.bases=e.base.match(matchPattern)||[];e.baseIndicies=e.bases.map(valueToInt);e.cleanName=e.name.replace(/\[|\]/g,"");const t=e.base.match(valuePattern)||[];this.indicies=t.map(valueToInt);this.indicies.forEach(e=>this.compiler.partIndicies.set(e,this))});this.eventMap=new Map}addListener(e,t){if(!this.eventMap.get(e)){this.node.addEventListener(e,t.bind(this.context));this.eventMap.set(e,t);!this.context.DEBUG?this.node.removeAttribute(`(${e})`):null}}disconnect(){if(this.eventMap.size){this.eventMap.forEach((e,t,s)=>{this.node.removeEventListener(t,e);s.delete(t)})}}updateProperty(e,t){const s=e.cleanName;!this.context.DEBUG?this.node.removeAttribute(e.name):null;this.node[s]=t;if(t&&(t!=="false"&&t!=="undefined")){this.node.setAttribute(s,t)}else{this.node.removeAttribute(s)}}update(e){this.boundAttrs.forEach(t=>{let s=t.base;for(let n=0;n<t.baseIndicies.length;n+=1){const o=t.baseIndicies[n];const i=e[o]||"";if(typeof i!=="function"){s=s.replace(`---!{${o}}!---`,i)}else{this.addListener(toEventName(t.name),i);this.boundAttrs.delete(t.name)}}t.value=s;if(t.name.match(propPattern)){if(t.baseIndicies.length===1){s=e[t.baseIndicies[0]]}this.updateProperty(t,s)}})}_updateAttribute(e,t){if(t&&(t!=="false"&&t!=="undefined")){this.node.setAttribute(e.name,t)}else{this.node.removeAttribute(e.name)}}_updateProp(e,t){const s=e.cleanName;this.node[s]=t;this.context.DEBUG?null:this.node.removeAttribute(e.name)}}class DirectiveNode{constructor(e,t,s,n,o){this.node=e;this.values=t;this.context=s;this.compiler=n;this.index=o;this.templateMap=null;this.compiler.partIndicies.set(o,this);this.node[repeaterSymbol]=[];this.repeater=this.node[repeaterSymbol];this.group=Symbol("Group")}init(){this.templates=this.values.map((e,t)=>{const[s,n]=e;const{$$key:o}=n;if(this.templateMap===null){if(typeof o!=="string"&&typeof o!=="number"){this.templateMap=new WeakMap}else{this.templateMap=new Map}}let i;if(this.templateMap.has(o)){i=this.templateMap.get(o);i.update(n)}else{i=new Template(s,n,this.node,this.context,this.group,t);this.templateMap.set(o,i)}this.node[this.group].set(t,i);this.repeater.push(...i.nodes);return i})}update(e){const t=e[this.index];const s=this.values;this.values=t;const n=new Set(this.values.map(([,e])=>e.$$key));const o=new Set(s.map(([,e])=>e.$$key));const i=new Set;n.forEach(e=>{o.has(e)?null:i.add(e)});o.forEach(e=>{const t=this.templateMap.get(e);if(t&&!n.has(e)){t[removeSymbol]();this.templateMap.delete(e)}});this.init()}}class Template{constructor(e,t,s,n,o=null,i=null){this.strings=e;this.values=t;this.oldValues=t.map((e,t)=>`---!{${t}}!---`);this.location=s;this.context=n;this.group=o;this.index=i;this.context.refs=this.context.refs||{};this.parts=[];this.partIndicies=new Map;this.context.$el=s;this.templateSymbol=Symbol("Template");this.nodes=[];this._init()}_append(e){this.nodes=Array.from(e.children).map(e=>{e[this.templateSymbol]=this;return e});if(this.location instanceof Comment){if(this.group){this.location[this.group]=this.location[this.group]||new Map;let t=this.location[this.group];this.location[this.group].set(this.index,this);if(this.index===0){this.location.after(e)}else{let s=this.index-1;while(!t.get(s)){s-=1}t.get(s).nodes[t.get(this.index-1).nodes.length-1].after(e)}}}else{this.location.appendChild(e);Promise.resolve().then(()=>{this.location.adoptedStyleSheets=this.location.adoptedStyleSheets})}if(!this.context[rendererSymbol]){protectProperty(this,rendererSymbol,this)}}_createBase(){return this.strings.map((e,t)=>{const s=this.values[t];const n=`---!{${t}}!---`;let o="";o+=e?e:"";if(s!==undefined&&!Array.isArray(s)){o+=n}else if(s!==undefined&&Array.isArray(s)){o+=`\x3c!-- ${n} --\x3e`}return o}).join("")}_createNode(e){let t=this[templateSymbol];if(!t){t=document.createElement("template");t.innerHTML=e}return document.importNode(t.content,true)}_init(){const e=this._createBase();const t=this._createNode(e);const s=document.createTreeWalker(t,133,null,false);this._walk(s,this.parts,true);this._append(t)}_walk(e,t){while(e.nextNode()){const{currentNode:s}=e;switch(s.nodeType){case 1:{const{attributes:e}=s;if(e.length){const n=new Map;const o=new Map;for(let t=0;t<e.length;t+=1){const o=e[t];if(o.value.match(valuePattern)||o.name.match(propPattern)){n.set(o.name,o)}else if(o.name.match("ref")){this.context.refs[o.value]=s}}if(n.size>=1||o.size>=1){const e=new AttributeNode(s,n,o,this.context,this);t.push(e);e.update(this.values,this.oldValues)}}break}case 3:{if(s.textContent&&s.textContent.match(valuePattern)){const e=new ContentNode(s,this);t.push(e);e.update(this.values,this.oldValues)}break}case 8:{const e=valueToInt(s.nodeValue);const n=this.values[e];const o=this.values[e];const i=new DirectiveNode(s,o,this.context,this,e,n);t.push(i);i.init(this.values[t.length-1]);break}}}}update(e){this.oldValues=this.values;this.values=e;for(let t=0;t<e.length;t+=1){const s=this.partIndicies.get(t);s&&!deepEqual(e[t],this.oldValues[t])&&s.update(e)}}[removeSymbol](){this.nodes.forEach(e=>e.parentNode.removeChild(e));this.parts.filter(e=>e instanceof AttributeNode).forEach(e=>e.disconnect());nullProps(this,["nodes","parts","partIndicies","context","location","group"])}}(function(){"use strict";const e="adoptedStyleSheets"in document;if(!e){function t(t){if(this[e]){this[e]._sheet.innerHTML=t;l(this);return this[e]._sheet.sheet}else{throw new TypeError("replaceSync can only be called on a constructed style sheet")}}function s(t){return new Promise((s,n)=>{if(this[e]){this[e]._sheet.innerHTML=t;s(this[e]._sheet.sheet);l(this)}else{n("replace can only be called on a constructed style sheet")}})}const e=Symbol("constructible style sheets");const n=Symbol("constructed");const o=Symbol("obsolete");const i=document.createElement("iframe");const r=t=>{t.forEach(t=>{const{addedNodes:s,removedNodes:i}=t;i.forEach(e=>{if(e[n]&&!e[o]){setTimeout(()=>{e[n].appendChild(e)})}});s.forEach(t=>{const{shadowRoot:s}=t;if(s&&s.adoptedStyleSheets){s.adoptedStyleSheets.forEach(t=>{s.appendChild(t[e]._sheet)})}})})};const a=new MutationObserver(r);a.observe(document.body,{childList:true});i.hidden=true;document.body.appendChild(i);const c=(t,s)=>{const o=s[e]._sheet.cloneNode(true);t.body?t=t.body:null;o[n]=t;s[e]._adopters.push({location:t,clone:o});t.appendChild(o);return o};const l=t=>{t[e]._adopters.forEach(s=>{s.clone.innerHTML=t[e]._sheet.innerHTML})};const h=(t,s)=>t=>{const n=t.target.shadowRoot;if(n&&n.adoptedStyleSheets.length){const t=n.adoptedStyleSheets;t.map(t=>t[e]).map(e=>{e._adopters=e._adopters.filter(e=>e.location!==n)})}s.disconnect()};class d{constructor(){this._adopters=[];const n=document.createElement("style");i.contentWindow.document.body.appendChild(n);this._sheet=n;n.sheet[e]=this;if(!n.sheet.constructor.prototype.replace){n.sheet.constructor.prototype.replace=s;n.sheet.constructor.prototype.replaceSync=t}return n.sheet}}StyleSheet.prototype.replace=s;CSSStyleSheet.prototype.replace=s;CSSStyleSheet.prototype.replaceSync=t;StyleSheet.prototype.replaceSync=t;window.CSSStyleSheet=d;const p={get(){return this._adopted||[]},set(t){const s=this.body?this.body:this;this._adopted=this._adopted||[];const n=new MutationObserver(r);n.observe(this,{childList:true});if(!Array.isArray(t)){throw new TypeError("Adopted style sheets must be an Array")}t.forEach(e=>{if(!e instanceof CSSStyleSheet){throw new TypeError("Adopted style sheets must be of type CSSStyleSheet")}});const i=[...new Set(t)];const a=this._adopted.filter(e=>!i.includes(e));a.forEach(t=>{const n=t[e]._adopters.filter(e=>e.location===s)[0].clone;n[o]=true;n.parentNode.removeChild(n)});this._adopted=i;if(this.isConnected){t.forEach(e=>{c(this,e)})}const l=h(this,n);this[l]=l;this.addEventListener("DOMNodeRemoved",l,true)}};Object.defineProperty(ShadowRoot.prototype,"adoptedStyleSheets",p);Object.defineProperty(document,"adoptedStyleSheets",p)}})(undefined);const templateCache=new WeakMap;function templiteral(e=this,t=this){e.shadowRoot?e=e.shadowRoot:null;return(s,...n)=>{let o=templateCache.get(e);if(o&&s===o.strings){o.update(n)}else if(o){[...o.location.children].forEach(e=>o.location.removeChild(e));o=new Template(s,n,e,t);templateCache.set(e,o)}else{o=new Template(s,n,e,t);templateCache.set(e,o)}return o}}function fragment(e){return(t,...s)=>{protectProperty(s,"$$key",e);return[t,s]}}function condition(e){return(t,...s)=>{protectProperty(s,"$$key",e?"condition":"false");return e?[[t,s]]:[[[],s]]}}class Component extends HTMLElement{static get boundAttributes(){return[]}static get boundProps(){return[]}static get observedAttributes(){return[...this.boundAttributes]}static get booleanAttributes(){return[]}constructor(){super();const e={};const t=new Set;const s=new Map;const n=watch(e,(e,t,s)=>{try{if(this.constructor.boundAttributes.includes(t)){if(s.value===false||s.value===null){this.removeAttribute(t)}else{this.setAttribute(t,s.value)}}this.render()}catch(e){console.log(e)}});Object.defineProperty(this,"state",{get(){return n},set(t){Object.keys(t).forEach(s=>{if(typeof t[s]!=="string"||typeof t[s]!=="number"){e[s]=t[s]}else{e[s]=watch(t[s],()=>this.render())}});return true}});this.constructor.boundAttributes.map((e,s,n)=>{Object.defineProperty(this,e,{get(){if(this.constructor.booleanAttributes.includes(e)){return this.hasAttribute(e)}return this.getAttribute(e)},set(s){if(this.constructor.booleanAttributes.includes(e)){if(s||s===""){this.setAttribute(e,true)}else{this.removeAttribute(e)}}else{if(s){this.setAttribute(e,s)}else{this.removeAttribute(e)}}if(this.constructor.boundProps.includes(name)){this[name]=s}if(this.isConnected&&t.size===n.length){this.render()}if(this.updatedHooks.has(e)&&this.$$listening){this.updatedHooks.get(e).apply(this,[s,e])}t.add(e)}})});protectGet(this,"templiteral",()=>templiteral(this.shadowRoot?this.shadowRoot:this,this));protectGet(this,"html",()=>(...e)=>Reflect.apply(this.templiteral,this,e));protectProperty(this,"updatedHooks",s);protectProperty(this,"fragment",fragment);protectProperty(this,"if",condition)}attributeChangedCallback(e,t,s){if(this.constructor.booleanAttributes.includes(e)&&t!==s){s=s===""?true:s;this.state[e]=!!s;if(this.constructor.boundProps.includes(e)){this[e]=!!s}}else if(t!==s){this.state[e]=s;if(this.constructor.boundProps.includes(e)){this[e]=s}}this.emit("ComponentRender",{component:this,time:Date.now()})}connectedCallback(){this.render();if(!this.$$listening){this.addEventListener("ComponentRender",this.render)}this.$$listening=true;this.onInit()}disconnectedCallback(){templateCache.delete(this);this.removeEventListener("ComponentRender",this.render);this.$$listening=false;this[rendererSymbol]&&this[rendererSymbol][removeSymbol]();this.onDestroy()}emit(e,t){this.dispatchEvent(new CustomEvent(e,{bubbles:true,composed:true,detail:t}))}onInit(){}onDestroy(){}render(){}}const watch=(e,t)=>{const s={get(e,t,n){try{const o=Object.getOwnPropertyDescriptor(e,t);const i=Reflect.get(e,t,n);if(o&&!o.writable&&!o.configurable){return i}if(typeof e[t]==="function"&&(e instanceof Date||e instanceof Map||e instanceof WeakMap)){return new Proxy(e[t].bind(e),s)}return new Proxy(e[t],s)}catch(s){if(e instanceof HTMLElement){return e[t]}return Reflect.get(e,t,n)}},set(e,s,n){e[s]=n;t(e,s,{value:n});return true},defineProperty(e,s,n){const o=Reflect.defineProperty(e,s,n);t(e,s,n);return o},deleteProperty(e,s,n){const o=Reflect.deleteProperty(e,s);t(e,s,n);return o}};return new Proxy(e,s)};exports.templiteral=templiteral;exports.fragment=fragment;exports.condition=condition;exports.Component=Component;exports.watch=watch;