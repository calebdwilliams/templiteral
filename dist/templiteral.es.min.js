const valuePattern=/---!{.*?(}!---)/gi;const propPattern=/^\[.*\]$/;const matchPattern=/---!{\d+}!---/gi;const removeSymbol=Symbol("RemoveTemplate");const rendererSymbol=Symbol("Renderer");const repeaterSymbol=Symbol("Repeater");const valueToInt=e=>+e.replace(/(---!{)|(}!---)/gi,"");const toEventName=e=>e.replace(/(\()|(\))/gi,"");class ContentNode{constructor(e,t){this.node=e;this.compiler=t;this.base=e.nodeValue||"";this.indicies=this.base.match(valuePattern).map(valueToInt);this.indicies.forEach(e=>this.compiler.partIndicies.set(e,this))}update(e){this.node.nodeValue=this.base.replace(matchPattern,t=>{const n=e[valueToInt(t)];return n===null?"":e[valueToInt(t)]})}}class AttributeNode{constructor(e,t,n,s,i){this.node=e;this.boundAttrs=t;this.boundEvents=n;this.context=s;this.compiler=i;this.boundAttrs.forEach(e=>{e.base=e.value;e.bases=e.base.match(matchPattern)||[];e.baseIndicies=e.bases.map(valueToInt);e.cleanName=e.name.replace(/\[|\]/g,"");const t=e.base.match(valuePattern)||[];this.indicies=t.map(valueToInt);this.indicies.forEach(e=>this.compiler.partIndicies.set(e,this))});this.eventMap=new Map}addListener(e,t){if(!this.eventMap.get(e)){this.node.addEventListener(e,t.bind(this.context));this.eventMap.set(e,t);!this.context.DEBUG?this.node.removeAttribute(`(${e})`):null}}disconnect(){if(this.eventMap.size){this.eventMap.forEach((e,t,n)=>{this.node.removeEventListener(t,e);n.delete(t)})}}updateProperty(e,t){const n=e.cleanName;!this.context.DEBUG?this.node.removeAttribute(e.name):null;this.node[n]=t;if(t&&(t!=="false"&&t!=="undefined")){this.node.setAttribute(n,t)}else{this.node.removeAttribute(n)}}update(e){this.boundAttrs.forEach(t=>{let n=t.base;for(let s=0;s<t.baseIndicies.length;s+=1){const i=t.baseIndicies[s];const r=e[i]||"";if(typeof r!=="function"){n=n.replace(`---!{${i}}!---`,r)}else{this.addListener(toEventName(t.name),r);this.boundAttrs.delete(t.name)}}t.value=n;if(t.name.match(propPattern)){if(t.baseIndicies.length===1){n=e[t.baseIndicies[0]]}this.updateProperty(t,n)}})}}const deepEqual=(e,t)=>{if(e===t)return true;if(e&&t&&typeof e=="object"&&typeof t=="object"){const n=Array.isArray(e);const s=Array.isArray(t);let i;let r;let o;if(n&&s){r=e.length;if(r!=t.length)return false;for(i=r;i--!==0;)if(!deepEqual(e[i],t[i]))return false;return true}if(n!=s)return false;const a=e instanceof Date;const l=t instanceof Date;if(a!=l)return false;if(a&&l)return e.getTime()==t.getTime();const c=e instanceof RegExp;const h=t instanceof RegExp;if(c!=h)return false;if(c&&h)return e.toString()==t.toString();const u=Object.keys(e);r=u.length;if(r!==Object.keys(t).length)return false;for(i=r;i--!==0;)if(!Object.hasOwnProperty.call(t,u[i]))return false;for(i=r;i--!==0;){o=u[i];if(!deepEqual(e[o],t[o]))return false}return true}else if(e&&t&&typeof e=="function"&&typeof t=="function"){return true}return e!==e&&t!==t};class DirectiveNode{constructor(e,t,n,s,i){this.node=e;this.values=t;this.context=n;this.compiler=s;this.index=i;this.templateMap=null;this.compiler.partIndicies.set(i,this);this.node[repeaterSymbol]=[];this.repeater=this.node[repeaterSymbol];this.group=Symbol("Group")}init(){this.templates=this.values.map((e,t)=>{const[n,s]=e;const{$$key:i}=s;if(this.templateMap===null){if(typeof i!=="string"&&typeof i!=="number"){this.templateMap=new WeakMap}else{this.templateMap=new Map}}let r;if(this.templateMap.has(i)){r=this.templateMap.get(i);r.update(s)}else{r=new Template(n,s,this.node,this.context,this.group,t);this.templateMap.set(i,r)}this.node[this.group].set(t,r);this.repeater.push(...r.nodes);return r})}update(e){const t=e[this.index];const n=this.values;this.values=t;const s=new Set(this.values.map(([,e])=>e.$$key));const i=new Set(n.map(([,e])=>e.$$key));const r=new Set;s.forEach(e=>{i.has(e)?null:r.add(e)});i.forEach(e=>{const t=this.templateMap.get(e);if(t&&!s.has(e)){t[removeSymbol]();this.templateMap.delete(e)}});this.init()}}class Template{constructor(e,t,n,s,i=null,r=null){this.strings=e;this.values=t;this.oldValues=t.map((e,t)=>`---!{${t}}!---`);this.location=n;this.context=s;this.group=i;this.index=r;this.context.refs=this.context.refs||{};this.parts=[];this.partIndicies=new Map;this.context.$el=n;this.templateSymbol=Symbol("Template");this.nodes=[];this._init()}_append(e){this.nodes=Array.from(e.children).map(e=>{e[this.templateSymbol]=this;return e});if(this.location instanceof Comment){if(this.group){this.location[this.group]=this.location[this.group]||new Map;let t=this.location[this.group];this.location[this.group].set(this.index,this);if(this.index===0){this.location.after(e)}else{let n=this.index-1;while(!t.get(n)){n-=1}t.get(n).nodes[t.get(this.index-1).nodes.length-1].after(e)}}}else{this.location.appendChild(e)}if(!this.context[rendererSymbol]){Object.defineProperty(this,rendererSymbol,{value:this,enumerable:false,configurable:false,writable:false});this.context.onInit&&typeof this.context.onInit==="function"&&this.context.onInit()}}_createBase(){return this.strings.map((e,t)=>{const n=this.values[t];const s=`---!{${t}}!---`;let i="";i+=e?e:"";if(n!==undefined&&!Array.isArray(n)){i+=s}else if(n!==undefined&&Array.isArray(n)){i+=`\x3c!-- ${s} --\x3e`}return i}).join("")}_createNode(e){const t=document.createElement("template");t.innerHTML=e;return document.importNode(t.content,true)}_init(){const e=this._createBase();const t=this._createNode(e);const n=document.createTreeWalker(t,133,null,false);this._walk(n,this.parts,true);this._append(t)}_walk(e,t){while(e.nextNode()){const{currentNode:n}=e;switch(n.nodeType){case 1:{const{attributes:e}=n;if(e.length){const s=new Map;const i=new Map;for(let t=0;t<e.length;t+=1){const i=e[t];if(i.value.match(valuePattern)||i.name.match(propPattern)){s.set(i.name,i)}else if(i.name.match("ref")){this.context.refs[i.value]=n}}if(s.size>=1||i.size>=1){const e=new AttributeNode(n,s,i,this.context,this);t.push(e);e.update(this.values,this.oldValues)}}break}case 3:{if(n.textContent&&n.textContent.match(valuePattern)){const e=new ContentNode(n,this);t.push(e);e.update(this.values,this.oldValues)}break}case 8:{const e=valueToInt(n.nodeValue);const s=this.values[e];const i=this.values[e];const r=new DirectiveNode(n,i,this.context,this,e,s);t.push(r);r.init(this.values[t.length-1]);break}}}}update(e){this.oldValues=this.values;this.values=e;for(let t=0;t<e.length;t+=1){const n=this.partIndicies.get(t);n&&!deepEqual(e[t],this.oldValues[t])&&n.update(e)}}[removeSymbol](){this.nodes.forEach(e=>e.parentNode.removeChild(e));this.nodes=null;this.parts.filter(e=>e instanceof AttributeNode).forEach(e=>e.disconnect());this.parts=null;this.partIndicies=null;this.context=null;this.location=null;this.group=null}}const templateCache=new WeakMap;function templiteral(e=this,t=this){e.shadowRoot?e=e.shadowRoot:null;return(n,...s)=>{let i=templateCache.get(e);if(i&&n===i.strings){i.update(s)}else if(i){[...i.location.children].forEach(e=>i.location.removeChild(e));i=new Template(n,s,e,t);templateCache.set(e,i)}else{i=new Template(n,s,e,t);templateCache.set(e,i)}return i}}function fragment(e){return(t,...n)=>{Object.defineProperty(n,"$$key",{value:e,enumerable:false,configurable:false,writable:false});return[t,n]}}function condition(e){return(t,...n)=>{Object.defineProperty(n,"$$key",{value:e?"condition":"false",enumerable:false,configurable:false,writable:false});return e?[[t,n]]:[[[],n]]}}class Component extends HTMLElement{static get boundAttributes(){return[]}static get observedAttributes(){return[...this.boundAttributes]}static get renderer(){return"render"}constructor(e){super();if(e){this.attachShadow(e)}const t={};const n=this;const s=new Set;const i=watch(t,(e,t,n)=>{try{if(this.constructor.boundAttributes.includes(t)){if(n.value===false||n.value===null){this.removeAttribute(t)}else{this.setAttribute(t,n.value)}}this[this.constructor.renderer].bind(this)()}catch(e){console.log(e)}});Object.defineProperty(this,"state",{get(){return i},set(e){Object.keys(e).forEach(n=>{if(typeof e[n]!=="string"||typeof e[n]!=="number"){t[n]=e[n]}else{t[n]=watch(e[n],()=>this[this.constructor.renderer]())}});return true}});this.constructor.boundAttributes.map((e,t,n)=>{Object.defineProperty(this,e,{get(){return this.getAttribute(e)||this.hasAttribute(e)},set(t){if(t||t===""){this.setAttribute(e,t)}else{this.removeAttribute(e)}if(this.constructor.renderer&&typeof this[this.constructor.renderer]==="function"&&this.isConnected&&s.size===n.length){this[this.constructor.renderer]()}s.add(e)}})});Object.defineProperty(this,"templiteral",{get(){const e=n.shadowRoot?n.shadowRoot:n;return templiteral(e,n)},configurable:false,enumerable:false});Object.defineProperty(this,"html",{get(){return(...e)=>Reflect.apply(n.templiteral,n,e)},configurable:false,enumerable:false});Object.defineProperty(this,"fragment",{value:fragment,configurable:false,enumerable:false,writable:false});Object.defineProperty(this,"if",{value:condition,configurable:false,enumerable:false,writable:false})}attributeChangedCallback(e,t,n){if(t!==n){this.state[e]=n}else if(n===""&&this.hasAttribute(e)){this.state[e]=true}this.emit("ComponentRender",{component:this,time:Date.now()})}get $$renderListener(){return this[this.constructor.renderer]}connectedCallback(){if(this.constructor.renderer&&typeof this[this.constructor.renderer]==="function"){this[this.constructor.renderer]();if(!this.$$listening){this.addEventListener("ComponentRender",this.$$renderListener)}}this.$$listening=true}disconnectedCallback(){templateCache.delete(this);if(this.constructor.renderer&&typeof this[this.constructor.renderer]==="function"){this.removeEventListener("ComponentRender",this.$$renderListener);this.$$listening=false}this[rendererSymbol]&&this[rendererSymbol][removeSymbol]();if(this.onDestroy&&typeof this.onDestroy==="function"){this.onDestroy()}}emit(e,t){this.dispatchEvent(new CustomEvent(e,{bubbles:true,composed:true,detail:t}))}}const watch=(e,t)=>{const n={get(e,t,s){try{const i=Object.getOwnPropertyDescriptor(e,t);const r=Reflect.get(e,t,s);if(i&&!i.writable&&!i.configurable){return r}if(typeof e[t]==="function"&&(e instanceof Date||e instanceof Map||e instanceof WeakMap)){return new Proxy(e[t].bind(e),n)}return new Proxy(e[t],n)}catch(n){if(e instanceof HTMLElement){return e[t]}return Reflect.get(e,t,s)}},set(e,n,s){e[n]=s;t(e,n,{value:s});return true},defineProperty(e,n,s){const i=Reflect.defineProperty(e,n,s);t(e,n,s);return i},deleteProperty(e,n,s){const i=Reflect.deleteProperty(e,n);t(e,n,s);return i}};return new Proxy(e,n)};const debounce=(e,t,n)=>{let s;return function i(...r){const o=this;const a=()=>{s=null;!n&&Reflect.apply(e,o,r)};const l=n&&!s;clearTimeout(s);s=setTimeout(a,t);l&&Reflect.apply(e,o,r)}};export{templiteral,fragment,condition,Component,watch,debounce};